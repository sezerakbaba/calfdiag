<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ===== PWA META TAGS ===== -->
    <meta name="theme-color" content="#1976d2">
    <meta name="description" content="Buzağı İshali Hızlı Tanı ve İzleme Sistemi - Konya Veteriner Kontrol Enstitüsü">
    
    <!-- Apple PWA Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="CalfDiagNet">
    
    <!-- Microsoft PWA Tags -->
    <meta name="msapplication-TileColor" content="#1976d2">
    <meta name="msapplication-TileImage" content="/calfdiag/img/icon-144.png">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="CalfDiagNet - Buzağı İshali Takip">
    <meta property="og:description" content="Buzağı ishali hızlı tanı ve izleme sistemi">
    <meta property="og:image" content="/calfdiag/img/icon-512.png">
    <meta property="og:url" content="https://sezerakbaba.github.io/calfdiag/">
    
    <title>CalfDiagNet - Buzağı İshali Hızlı Tanı ve İzleme Sistemi</title>
    
    <!-- ===== PWA MANIFEST ===== -->
    <link rel="manifest" href="/calfdiag/manifest.webmanifest" crossorigin="use-credentials">
    
    <!-- ===== ICONS ===== -->
    <link rel="icon" href="/calfdiag/img/icon.png" type="image/png">
    <link rel="icon" href="/calfdiag/img/icon.svg" type="image/svg+xml">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/calfdiag/img/icon-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/calfdiag/img/icon-152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/calfdiag/img/icon-167.png">
    
    <!-- Microsoft Tile -->
    <meta name="msapplication-config" content="/calfdiag/browserconfig.xml">
    
    <!-- ===== STYLESHEETS ===== -->
    <link rel="stylesheet" href="/calfdiag/css/styles.css">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Leaflet CSS (Harita için) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Leaflet JS (Harita için) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
</head>
<body>
    <!-- ===== ANA KONTEYNER ===== -->
    <div class="container">
        <!-- ===== BAŞLIK ===== -->
        <header class="header">
            <div class="header-content">
                <h1>
                    <i class="fas fa-cow"></i>
                    CalfDiagNet
                </h1>
                <p class="subtitle">
                    Buzağı İshali Hızlı Tanı ve İzleme Sistemi
                    <br>
                    <small>Konya Veteriner Kontrol Enstitüsü Araştırma Projesi</small>
                </p>
                
                <!-- PWA Durum Göstergesi -->
                <div class="pwa-indicator" id="pwa-indicator">
                    <span id="connection-status">
                        <i class="fas fa-wifi"></i> Çevrimiçi
                    </span>
                    <span id="app-status">
                        <i class="fas fa-mobile-alt"></i> PWA Hazır
                    </span>
                </div>
            </div>
        </header>

        <!-- ===== NAVİGASYON MENÜSÜ ===== -->
        <nav class="navbar" id="main-nav">
            <a href="#dashboard" class="nav-link active" data-section="dashboard">
                <i class="fas fa-chart-line"></i>
                <span class="nav-text">Dashboard</span>
            </a>
            
            <a href="#new-test" class="nav-link" data-section="new-test">
                <i class="fas fa-vial"></i>
                <span class="nav-text">Yeni Test</span>
            </a>
            
            <a href="#statistics" class="nav-link" data-section="statistics">
                <i class="fas fa-chart-bar"></i>
                <span class="nav-text">İstatistikler</span>
            </a>
            
            <a href="#map" class="nav-link" data-section="map">
                <i class="fas fa-map-marked-alt"></i>
                <span class="nav-text">Harita</span>
            </a>
            
            <a href="#settings" class="nav-link" data-section="settings">
                <i class="fas fa-cog"></i>
                <span class="nav-text">Ayarlar</span>
            </a>
        </nav>

        <!-- ===== ANA İÇERİK ALANI ===== -->
        <main class="main-content" id="main-content">
            <!-- === DASHBOARD BÖLÜMÜ === -->
            <section id="dashboard" class="content-section active">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard
                    </h2>
                    <div class="section-controls">
                        <button class="btn btn-sm btn-outline" onclick="refreshData()" title="Verileri Yenile">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="exportData()" title="Dışa Aktar">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>

                <!-- İstatistik Kartları -->
                <div class="stats-grid">
                    <div class="stat-card stat-primary">
                        <div class="stat-icon">
                            <i class="fas fa-flask"></i>
                        </div>
                        <h3>Toplam Test</h3>
                        <p class="stat-number" id="total-tests">0</p>
                        <p class="stat-trend">
                            <i class="fas fa-arrow-up text-success"></i>
                            <span>+5 son 7 gün</span>
                        </p>
                    </div>
                    
                    <div class="stat-card stat-warning">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3>Pozitif Vakalar</h3>
                        <p class="stat-number" id="positive-cases">0</p>
                        <div class="stat-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="positivity-rate" style="width: 0%"></div>
                            </div>
                            <span id="positivity-percent">0%</span>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-success">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-week"></i>
                        </div>
                        <h3>Son 7 Gün</h3>
                        <p class="stat-number" id="last-week-tests">0</p>
                        <p class="stat-subtext">Bu haftaki testler</p>
                    </div>
                    
                    <div class="stat-card stat-danger">
                        <div class="stat-icon">
                            <i class="fas fa-bacteria"></i>
                        </div>
                        <h3>Ko-enfeksiyon</h3>
                        <p class="stat-number" id="coinfection-cases">0</p>
                        <p class="stat-subtext">Çoklu patojen</p>
                    </div>
                </div>

                <!-- Hızlı Aksiyonlar -->
                <div class="quick-actions-section">
                    <h3>
                        <i class="fas fa-bolt"></i>
                        Hızlı Aksiyonlar
                    </h3>
                    <div class="quick-actions">
                        <button class="btn btn-primary btn-lg" onclick="showSection('new-test')">
                            <i class="fas fa-plus-circle"></i>
                            Yeni Test Ekle
                        </button>
                        <button class="btn btn-secondary btn-lg" onclick="showStatisticsModal()">
                            <i class="fas fa-chart-pie"></i>
                            Detaylı Rapor
                        </button>
                        <button class="btn btn-outline btn-lg" onclick="showMapView()">
                            <i class="fas fa-map-marker-alt"></i>
                            Haritada Göster
                        </button>
                    </div>
                </div>

                <!-- Son Eklenen Testler -->
                <div class="recent-tests">
                    <h3>
                        <i class="fas fa-history"></i>
                        Son Eklenen Testler
                    </h3>
                    <div class="tests-table-container">
                        <table class="tests-table" id="recent-tests-table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Buzağı No</th>
                                    <th>Lokasyon</th>
                                    <th>Patojenler</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody id="recent-tests-body">
                                <!-- JavaScript ile dolacak -->
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="loading-spinner">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            Veriler yükleniyor...
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- === YENİ TEST FORM BÖLÜMÜ === -->
            <section id="new-test" class="content-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-vial"></i>
                        Yeni Hızlı Test Ekle
                    </h2>
                    <div class="section-controls">
                        <button class="btn btn-sm btn-outline" onclick="clearForm()" title="Formu Temizle">
                            <i class="fas fa-eraser"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="scanQRCode()" title="QR Kod Tara">
                            <i class="fas fa-qrcode"></i>
                        </button>
                    </div>
                </div>

                <!-- Form Container -->
                <div class="form-container">
                    <form id="test-form" class="test-form" novalidate>
                        <!-- Temel Bilgiler -->
                        <fieldset class="form-section">
                            <legend>
                                <i class="fas fa-info-circle"></i>
                                Temel Bilgiler
                            </legend>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="calf-id">
                                        <i class="fas fa-tag"></i>
                                        Buzağı Numarası *
                                    </label>
                                    <input type="text" id="calf-id" name="calf-id" 
                                           placeholder="Örn: CALF-2024-001" required
                                           pattern="CALF-\d{4}-\d{3}"
                                           title="Format: CALF-YYYY-NNN">
                                    <small class="form-help">Format: CALF-YYYY-NNN</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="calf-age">
                                        <i class="fas fa-birthday-cake"></i>
                                        Buzağı Yaşı (gün) *
                                    </label>
                                    <input type="number" id="calf-age" name="calf-age" 
                                           min="0" max="365" required
                                           placeholder="Örn: 15">
                                    <small class="form-help">0-365 gün arası</small>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="farmer-name">
                                        <i class="fas fa-user"></i>
                                        Çiftçi Adı *
                                    </label>
                                    <input type="text" id="farmer-name" name="farmer-name" 
                                           placeholder="Örn: Ahmet Yılmaz" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="farm-name">
                                        <i class="fas fa-home"></i>
                                        İşletme Adı
                                    </label>
                                    <input type="text" id="farm-name" name="farm-name" 
                                           placeholder="Örn: Yılmaz Çiftliği">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="location">
                                    <i class="fas fa-map-marker-alt"></i>
                                    İşletme Lokasyonu *
                                </label>
                                <div class="location-input">
                                    <input type="text" id="location" name="location" 
                                           placeholder="Örn: Konya-Meram, Selçuklu, Karatay..." required>
                                    <button type="button" class="btn btn-sm btn-outline" 
                                            onclick="getCurrentLocation()" title="Konumu Al">
                                        <i class="fas fa-location-arrow"></i>
                                    </button>
                                </div>
                                <div id="coordinates-display" class="coordinates-display" style="display: none;">
                                    <small>
                                        <i class="fas fa-crosshairs"></i>
                                        Koordinatlar: 
                                        <span id="lat-display">-</span>, 
                                        <span id="lng-display">-</span>
                                    </small>
                                </div>
                            </div>
                        </fieldset>

                        <!-- Test Sonuçları -->
                        <fieldset class="form-section">
                            <legend>
                                <i class="fas fa-microscope"></i>
                                Hızlı Test Sonuçları
                            </legend>
                            
                            <div class="test-kit-info">
                                <p class="info-note">
                                    <i class="fas fa-info-circle"></i>
                                    Test kiti üzerindeki sonuçlara göre işaretleyin.
                                    <strong>Pozitif bulunan tüm patojenleri işaretleyin.</strong>
                                </p>
                            </div>
                            
                            <div class="pathogen-grid">
                                <!-- Bovine Rotavirus -->
                                <div class="pathogen-card" data-pathogen="BRV">
                                    <div class="pathogen-header">
                                        <h4>
                                            <i class="fas fa-virus"></i>
                                            Bovine Rotavirus
                                        </h4>
                                        <div class="pathogen-toggle">
                                            <label class="switch">
                                                <input type="checkbox" name="pathogen" value="BRV">
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <p class="pathogen-desc">
                                        Viral enterit - Sütten kesim öncesi buzağılarda
                                    </p>
                                </div>
                                
                                <!-- Bovine Coronavirus -->
                                <div class="pathogen-card" data-pathogen="BCoV">
                                    <div class="pathogen-header">
                                        <h4>
                                            <i class="fas fa-virus"></i>
                                            Bovine Coronavirus
                                        </h4>
                                        <div class="pathogen-toggle">
                                            <label class="switch">
                                                <input type="checkbox" name="pathogen" value="BCoV">
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <p class="pathogen-desc">
                                        Viral enterit - Her yaşta görülebilir
                                    </p>
                                </div>
                                
                                <!-- E. coli K99 -->
                                <div class="pathogen-card" data-pathogen="ETEC">
                                    <div class="pathogen-header">
                                        <h4>
                                            <i class="fas fa-bacteria"></i>
                                            E. coli K99 (ETEC)
                                        </h4>
                                        <div class="pathogen-toggle">
                                            <label class="switch">
                                                <input type="checkbox" name="pathogen" value="ETEC">
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <p class="pathogen-desc">
                                        Bakteriyel enterit - 0-4 günlük buzağılar
                                    </p>
                                </div>
                                
                                <!-- Cryptosporidium parvum -->
                                <div class="pathogen-card" data-pathogen="Cparvum">
                                    <div class="pathogen-header">
                                        <h4>
                                            <i class="fas fa-bug"></i>
                                            Cryptosporidium parvum
                                        </h4>
                                        <div class="pathogen-toggle">
                                            <label class="switch">
                                                <input type="checkbox" name="pathogen" value="Cparvum">
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <p class="pathogen-desc">
                                        Paraziter - 5-35 günlük buzağılarda yaygın
                                    </p>
                                </div>
                                
                                <!-- Clostridium difficile -->
                                <div class="pathogen-card" data-pathogen="Cdiff">
                                    <div class="pathogen-header">
                                        <h4>
                                            <i class="fas fa-skull-crossbones"></i>
                                            Clostridium difficile
                                        </h4>
                                        <div class="pathogen-toggle">
                                            <label class="switch">
                                                <input type="checkbox" name="pathogen" value="Cdiff">
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <p class="pathogen-desc">
                                        Toksin üreten bakteri - Antibiyotik sonrası
                                    </p>
                                </div>
                                
                                <!-- Giardia -->
                                <div class="pathogen-card" data-pathogen="Giardia">
                                    <div class="pathogen-header">
                                        <h4>
                                            <i class="fas fa-egg"></i>
                                            Giardia
                                        </h4>
                                        <div class="pathogen-toggle">
                                            <label class="switch">
                                                <input type="checkbox" name="pathogen" value="Giardia">
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <p class="pathogen-desc">
                                        Protozoan parazit - Kronik ishal
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Ko-enfeksiyon Uyarısı -->
                            <div class="coinfection-alert" id="coinfection-alert" style="display: none;">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <div>
                                        <strong>Ko-enfeksiyon Tespit Edildi!</strong>
                                        <p id="coinfection-message">Birden fazla patojen pozitif bulundu.</p>
                                    </div>
                                </div>
                            </div>
                        </fieldset>

                        <!-- Klinik Notlar ve Ek Bilgiler -->
                        <fieldset class="form-section">
                            <legend>
                                <i class="fas fa-stethoscope"></i>
                                Klinik Notlar
                            </legend>
                            
                            <div class="form-group">
                                <label for="clinical-notes">
                                    <i class="fas fa-notes-medical"></i>
                                    Klinik Gözlemler
                                </label>
                                <textarea id="clinical-notes" name="clinical-notes" 
                                          rows="4"
                                          placeholder="İshal şiddeti, dehidrasyon belirtileri, iştah durumu, diğer gözlemler..."></textarea>
                                <small class="form-help">
                                    Maksimum 500 karakter. 
                                    <span id="char-count">0/500</span>
                                </small>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="test-date">
                                        <i class="fas fa-calendar-alt"></i>
                                        Test Tarihi
                                    </label>
                                    <input type="date" id="test-date" name="test-date"
                                           value="<?php echo date('Y-m-d'); ?>">
                                </div>
                                
                                <div class="form-group">
                                    <label for="test-kit-photo">
                                        <i class="fas fa-camera"></i>
                                        Test Kit Fotoğrafı
                                    </label>
                                    <div class="file-upload">
                                        <label class="file-upload-label">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <span id="file-name">Dosya Seçilmedi</span>
                                            <input type="file" id="test-kit-photo" name="test-kit-photo"
                                                   accept="image/*" capture="environment"
                                                   style="display: none;">
                                        </label>
                                        <button type="button" class="btn btn-sm btn-outline" 
                                                onclick="takePhoto()">
                                            <i class="fas fa-camera"></i> Fotoğraf Çek
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </fieldset>

                        <!-- Form Aksiyon Butonları -->
                        <div class="form-actions">
                            <div class="form-preview">
                                <div class="preview-summary" id="form-preview">
                                    <i class="fas fa-eye"></i>
                                    <span>Önizleme: Henüz test eklenmedi</span>
                                </div>
                            </div>
                            
                            <div class="form-buttons">
                                <button type="button" class="btn btn-secondary" 
                                        onclick="showSection('dashboard')">
                                    <i class="fas fa-times"></i>
                                    İptal
                                </button>
                                
                                <button type="button" class="btn btn-outline" 
                                        onclick="saveDraft()">
                                    <i class="fas fa-save"></i>
                                    Taslak Kaydet
                                </button>
                                
                                <button type="submit" class="btn btn-primary" id="submit-btn">
                                    <i class="fas fa-check-circle"></i>
                                    Testi Kaydet
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </section>

            <!-- === İSTATİSTİKLER BÖLÜMÜ === -->
            <section id="statistics" class="content-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-chart-bar"></i>
                        İstatistikler ve Analizler
                    </h2>
                    <div class="section-controls">
                        <select id="time-range" class="form-select" onchange="updateCharts()">
                            <option value="7">Son 7 Gün</option>
                            <option value="30">Son 30 Gün</option>
                            <option value="90">Son 3 Ay</option>
                            <option value="365">Son 1 Yıl</option>
                        </select>
                    </div>
                </div>

                <!-- Grafikler Grid -->
                <div class="charts-grid">
                    <!-- Patojen Dağılımı -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>
                                <i class="fas fa-viruses"></i>
                                Patojen Dağılımı
                            </h3>
                            <div class="chart-legend" id="pathogen-legend"></div>
                        </div>
                        <div class="chart-container">
                            <canvas id="pathogenChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Zaman Serisi -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>
                                <i class="fas fa-chart-line"></i>
                                Zaman Serisi Analizi
                            </h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="timeSeriesChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Lokasyon Dağılımı -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>
                                <i class="fas fa-map"></i>
                                Lokasyon Bazlı Dağılım
                            </h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="locationChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Yaş Dağılımı -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>
                                <i class="fas fa-calendar-alt"></i>
                                Yaş Bazlı Pozitiflik
                            </h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="ageChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- İstatistik Tabloları -->
                <div class="stats-tables">
                    <div class="table-card">
                        <h3>
                            <i class="fas fa-table"></i>
                            Detaylı İstatistikler
                        </h3>
                        <div class="table-responsive">
                            <table class="stats-table">
                                <thead>
                                    <tr>
                                        <th>Patojen</th>
                                        <th>Toplam</th>
                                        <th>% Oran</th>
                                        <th>Son 7 Gün</th>
                                        <th>Trend</th>
                                    </tr>
                                </thead>
                                <tbody id="stats-table-body">
                                    <!-- JavaScript ile dolacak -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="table-card">
                        <h3>
                            <i class="fas fa-calculator"></i>
                            Özet Metrikler
                        </h3>
                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-label">Ortalama Pozitiflik</div>
                                <div class="metric-value" id="avg-positivity">0%</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Ko-enfeksiyon Oranı</div>
                                <div class="metric-value" id="coinfection-rate">0%</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">En Yaygın Patojen</div>
                                <div class="metric-value" id="most-common">-</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">En Riskli Bölge</div>
                                <div class="metric-value" id="risky-area">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- === HARİTA BÖLÜMÜ === -->
            <section id="map" class="content-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-map-marked-alt"></i>
                        Vaka Haritası
                    </h2>
                    <div class="section-controls">
                        <button class="btn btn-sm btn-outline" onclick="centerMap()" title="Haritayı Ortala">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="toggleHeatmap()" title="Isı Haritası">
                            <i class="fas fa-fire"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="exportMap()" title="Haritayı Kaydet">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>

                <!-- Harita Kontrolleri -->
                <div class="map-controls">
                    <div class="map-filters">
                        <select id="map-filter-pathogen" class="form-select" onchange="updateMap()">
                            <option value="all">Tüm Patojenler</option>
                            <option value="BRV">Bovine Rotavirus</option>
                            <option value="BCoV">Bovine Coronavirus</option>
                            <option value="ETEC">E. coli K99</option>
                            <option value="Cparvum">C. parvum</option>
                            <option value="Cdiff">C. difficile</option>
                            <option value="Giardia">Giardia</option>
                        </select>
                        
                        <select id="map-filter-time" class="form-select" onchange="updateMap()">
                            <option value="all">Tüm Zamanlar</option>
                            <option value="7">Son 7 Gün</option>
                            <option value="30">Son 30 Gün</option>
                            <option value="90">Son 3 Ay</option>
                        </select>
                        
                        <div class="map-legend">
                            <div class="legend-item">
                                <span class="legend-color" style="background: #ff0000;"></span>
                                <span>Yüksek Risk</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color" style="background: #ff9900;"></span>
                                <span>Orta Risk</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color" style="background: #ffff00;"></span>
                                <span>Düşük Risk</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Harita Container -->
                <div class="map-container">
                    <div id="map" style="height: 600px; border-radius: 10px;"></div>
                </div>

                <!-- Harita Bilgileri -->
                <div class="map-info">
                    <div class="info-card">
                        <h4>
                            <i class="fas fa-info-circle"></i>
                            Harita Bilgileri
                        </h4>
                        <div class="info-content">
                            <p>
                                <strong>Toplam İşaretlenmiş Lokasyon:</strong>
                                <span id="total-locations">0</span>
                            </p>
                            <p>
                                <strong>Aktif Vaka Sayısı:</strong>
                                <span id="active-cases">0</span>
                            </p>
                            <p>
                                <strong>Son Güncelleme:</strong>
                                <span id="map-update-time">-</span>
                            </p>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <h4>
                            <i class="fas fa-exclamation-triangle"></i>
                            Riskli Bölgeler
                        </h4>
                        <div class="info-content">
                            <ul id="risk-areas-list">
                                <li>Henüz riskli bölge tespit edilmedi</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- === AYARLAR BÖLÜMÜ === -->
            <section id="settings" class="content-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-cog"></i>
                        Ayarlar ve Yapılandırma
                    </h2>
                </div>

                <div class="settings-container">
                    <!-- PWA Ayarları -->
                    <div class="settings-card">
                        <h3>
                            <i class="fas fa-mobile-alt"></i>
                            PWA Ayarları
                        </h3>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Uygulamayı Yükle</h4>
                                <p>Telefonunuza ana ekrandan erişmek için yükleyin</p>
                            </div>
                            <button class="btn btn-primary" id="install-btn" style="display: none;">
                                <i class="fas fa-download"></i> Yükle
                            </button>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Çevrimdışı Mod</h4>
                                <p>İnternet yokken de çalışabilme</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="offline-mode" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Bildirimler</h4>
                                <p>Yeni pozitif vakalardan haberdar olun</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="notifications" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Veri Yönetimi -->
                    <div class="settings-card">
                        <h3>
                            <i class="fas fa-database"></i>
                            Veri Yönetimi
                        </h3>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Verileri Yedekle</h4>
                                <p>Tüm test verilerinizi yedekleyin</p>
                            </div>
                            <button class="btn btn-outline" onclick="backupData()">
                                <i class="fas fa-save"></i> Yedekle
                            </button>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Verileri Geri Yükle</h4>
                                <p>Önceki yedekten geri yükleyin</p>
                            </div>
                            <input type="file" id="restore-file" accept=".json" 
                                   style="display: none;">
                            <button class="btn btn-outline" onclick="document.getElementById('restore-file').click()">
                                <i class="fas fa-upload"></i> Geri Yükle
                            </button>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Verileri Temizle</h4>
                                <p>Tüm yerel verileri silin (dikkatli kullanın)</p>
                            </div>
                            <button class="btn btn-danger" onclick="clearAllData()">
                                <i class="fas fa-trash"></i> Temizle
                            </button>
                        </div>
                    </div>

                    <!-- Dışa Aktarma -->
                    <div class="settings-card">
                        <h3>
                            <i class="fas fa-file-export"></i>
                            Dışa Aktarma
                        </h3>
                        
                        <div class="export-options">
                            <button class="btn btn-outline" onclick="exportToExcel()">
                                <i class="fas fa-file-excel"></i> Excel (.xlsx)
                            </button>
                            <button class="btn btn-outline" onclick="exportToCSV()">
                                <i class="fas fa-file-csv"></i> CSV
                            </button>
                            <button class="btn btn-outline" onclick="exportToPDF()">
                                <i class="fas fa-file-pdf"></i> PDF Rapor
                            </button>
                            <button class="btn btn-outline" onclick="printReport()">
                                <i class="fas fa-print"></i> Yazdır
                            </button>
                        </div>
                    </div>

                    <!-- Sistem Bilgileri -->
                    <div class="settings-card">
                        <h3>
                            <i class="fas fa-info-circle"></i>
                            Sistem Bilgileri
                        </h3>
                        
                        <div class="system-info">
                            <div class="info-row">
                                <span>Uygulama Versiyonu</span>
                                <strong>v1.0.0</strong>
                            </div>
                            <div class="info-row">
                                <span>Son Güncelleme</span>
                                <strong id="last-update">-</strong>
                            </div>
                            <div class="info-row">
                                <span>Toplam Test Sayısı</span>
                                <strong id="total-tests-info">0</strong>
                            </div>
                            <div class="info-row">
                                <span>Cache Boyutu</span>
                                <strong id="cache-size">0 KB</strong>
                            </div>
                            <div class="info-row">
                                <span>Çevrimdışı Depolama</span>
                                <strong id="offline-storage">Etkin</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- ===== FOOTER ===== -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>
                        <i class="fas fa-project-diagram"></i>
                        Proje Bilgisi
                    </h4>
                    <p>
                        CalfDiagNet - Buzağı İshali Hızlı Tanı ve İzleme Sistemi
                    </p>
                    <p class="small-text">
                        Konya Veteriner Kontrol Enstitüsü Araştırma Projesi
                    </p>
                </div>
                
                <div class="footer-section">
                    <h4>
                        <i class="fas fa-link"></i>
                        Hızlı Linkler
                    </h4>
                    <ul class="footer-links">
                        <li><a href="#dashboard" onclick="showSection('dashboard')">Dashboard</a></li>
                        <li><a href="#new-test" onclick="showSection('new-test')">Yeni Test Ekle</a></li>
                        <li><a href="#statistics" onclick="showSection('statistics')">İstatistikler</a></li>
                        <li><a href="#map" onclick="showSection('map')">Harita</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>
                        <i class="fas fa-shield-alt"></i>
                        Güvenlik ve Gizlilik
                    </h4>
                    <p class="small-text">
                        Tüm veriler yerel cihazınızda saklanır.
                        Sunucuya gönderilmez.
                    </p>
                    <button class="btn btn-sm btn-outline" onclick="showPrivacyPolicy()">
                        <i class="fas fa-user-shield"></i> Gizlilik Politikası
                    </button>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>
                    &copy; 2024 CalfDiagNet. Tüm hakları saklıdır.
                    <span id="app-version">v1.0.0</span>
                </p>
                <p class="pwa-status" id="pwa-status">
                    <i class="fas fa-circle" id="status-icon"></i>
                    <span id="status-text">Çevrimiçi - PWA Hazır</span>
                </p>
            </div>
        </footer>
    </div>

    <!-- ===== MODALLAR ===== -->
    
    <!-- Başarı Modalı -->
    <div class="modal" id="success-modal">
        <div class="modal-content">
            <div class="modal-header success">
                <h3>
                    <i class="fas fa-check-circle"></i>
                    Başarılı!
                </h3>
                <button class="modal-close" onclick="closeModal('success-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="success-message">Test başarıyla kaydedildi.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('success-modal')">
                    Tamam
                </button>
            </div>
        </div>
    </div>

    <!-- Hata Modalı -->
    <div class="modal" id="error-modal">
        <div class="modal-content">
            <div class="modal-header error">
                <h3>
                    <i class="fas fa-exclamation-circle"></i>
                    Hata!
                </h3>
                <button class="modal-close" onclick="closeModal('error-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="error-message">Bir hata oluştu.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('error-modal')">
                    Kapat
                </button>
            </div>
        </div>
    </div>

    <!-- Yükleme Spinner -->
    <div class="loader" id="loader" style="display: none;">
        <div class="loader-content">
            <div class="spinner">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <p id="loader-text">Yükleniyor...</p>
        </div>
    </div>

    <!-- Offline Mesajı -->
    <div class="offline-banner" id="offline-banner" style="display: none;">
        <div class="offline-content">
            <i class="fas fa-wifi-slash"></i>
            <span>Çevrimdışı moddasınız. Değişiklikleriniz internet bağlantınız kurulunca senkronize edilecek.</span>
        </div>
    </div>

    <!-- ===== SCRIPTS ===== -->
    
    <!-- Ana Uygulama JavaScript -->
    <script src="/calfdiag/js/app.js"></script>
    
    <!-- Service Worker Kayıt -->
    <script>
        // Service Worker kaydı
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/calfdiag/sw.js')
                    .then(function(registration) {
                        console.log('Service Worker kaydedildi:', registration.scope);
                        
                        // Service Worker durumunu güncelle
                        updateServiceWorkerStatus(registration);
                        
                        // Çevrimdışı durumu dinle
                        registration.addEventListener('updatefound', function() {
                            console.log('Service Worker güncelleniyor...');
                        });
                    })
                    .catch(function(error) {
                        console.log('Service Worker kaydı başarısız:', error);
                        document.getElementById('status-text').textContent = 'Çevrimdışı destek yok';
                        document.getElementById('status-icon').style.color = '#dc3545';
                    });
            });
        }

        // PWA kurulumu için
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Kurulum butonunu göster
            const installBtn = document.getElementById('install-btn');
            if (installBtn) {
                installBtn.style.display = 'block';
                installBtn.addEventListener('click', () => {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('Kullanıcı PWA kurulumunu kabul etti');
                            installBtn.style.display = 'none';
                        }
                        deferredPrompt = null;
                    });
                });
            }
        });

        // Çevrimdışı/ağ durumu kontrolü
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connection-status');
            const offlineBanner = document.getElementById('offline-banner');
            
            if (navigator.onLine) {
                statusEl.innerHTML = '<i class="fas fa-wifi"></i> Çevrimiçi';
                statusEl.style.color = '#28a745';
                if (offlineBanner) offlineBanner.style.display = 'none';
            } else {
                statusEl.innerHTML = '<i class="fas fa-wifi-slash"></i> Çevrimdışı';
                statusEl.style.color = '#dc3545';
                if (offlineBanner) offlineBanner.style.display = 'flex';
            }
        }

        // Ağ durumu değişikliklerini dinle
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
        
        // İlk durumu ayarla
        updateConnectionStatus();

        // Service Worker durumunu güncelle
        function updateServiceWorkerStatus(registration) {
            if (registration.active) {
                document.getElementById('status-text').textContent = 'Çevrimdışı destek aktif';
                document.getElementById('status-icon').style.color = '#28a745';
            }
        }

        // Uygulama versiyonunu güncelle
        document.getElementById('app-version').textContent = 'v1.0.0';
        
        // Son güncelleme tarihini ayarla
        document.getElementById('last-update').textContent = new Date().toLocaleDateString('tr-TR');
    </script>
</body>
</html>